{{define "queryFile"}}// Code generated by sqlc. DO NOT EDIT.
// source: {{.SourceName}}

import { Database, QueryExecResult } from "@stephen/sql.js";

{{template "queryCode" . }}
{{end}}

{{define "queryCode"}}
{{range .Queries}}
{{if $.OutputQuery .SourceName}}
const {{.ConstantName}} = {{$.Q}}-- name: {{.MethodName}} {{.Cmd}}
{{escape .SQL}}
{{$.Q}};

{{if .Arg.EmitStruct}}
export type {{.Arg.Type}} = { {{- range .Arg.UniqueFields}}
  {{.Name}}: {{.Type}};
  {{- end}}
}
{{end}}

{{if .Ret.EmitStruct}}
export type {{.Ret.Type}} = { {{- range .Ret.Struct.Fields}}
  {{.Name}}: {{.Type}};
  {{- end}}
}
{{end}}

{{if eq .Cmd ":one"}}
{{range .Comments}}//{{.}}
{{end -}}
export function {{.MethodName}}(db: Database, {{.Arg.Pair}}): {{.Ret.DefineType}} | null {
  const result = db.exec({{.ConstantName}}, [id])
  if (result.length !== 1) {
    throw new Error("expected exec() to return a single query result")
  }

  const queryResult = result[0];
  if (queryResult.values.length !== 1) {
    return null;
  }

  const columns = queryResult.columns;
  const row = queryResult.values[0];
  {{- range $i, $e := .Ret.UniqueFields}}
  if ({{$e.Typecheck $i}}) { throw new Error(`expected type {{$e.Type}} for column {{$e.Name}}, but got ${typeof row[{{$i}}]}`) };
  {{- end}}
  const rv: {{.Ret.DefineType}} = { {{- range $i, $e := .Ret.UniqueFields}}
    {{$e.Name}}: row[{{$i}}],
    {{- end}}
  };
  return rv;
}
{{end}}

{{if eq .Cmd ":many"}}
{{range .Comments}}//{{.}}
{{end -}}
export function {{.MethodName}}(db: Database, {{.Arg.Pair}}): {{.Ret.DefineType}}[] {
  const result = db.exec({{.ConstantName}}, [{{.Arg.Params}}])
  if (result.length !== 1) {
    throw new Error("expected exec() to return a single query result")
  }

  const queryResult = result[0];
  const rvs: {{.Ret.DefineType}}[] = [];

  for (const row of queryResult.values) {
  const columns = queryResult.columns;
    {{- range $i, $e := .Ret.UniqueFields}}
    if ({{$e.Typecheck $i}}) { throw new Error(`expected type {{$e.Type}} for column {{$e.Name}}, but got ${typeof row[{{$i}}]}`) };
    {{- end}}
    const rv: {{.Ret.DefineType}} = { {{- range $i, $e := .Ret.UniqueFields}}
      {{$e.Name}}: row[{{$i}}],
      {{- end}}
    };
    rvs.push(rv);
  }
  return rvs;
}
{{end}}

{{if eq .Cmd ":exec"}}
{{range .Comments}}//{{.}}
{{end -}}
export function {{.MethodName}}(db: Database, {{.Arg.Pair}}): void {
 db.exec({{.ConstantName}}, [{{.Arg.Params}}])
}
{{end}}

{{if eq .Cmd ":execrows"}}
{{range .Comments}}//{{.}}
{{end -}}
export function {{.MethodName}}(db: Database, {{.Arg.Pair}}): number {
  const result = db.exec({{.ConstantName}}, [{{.Arg.Params}}])
  if (result.length !== 1) {
    throw new Error("expected exec() to return a single query result")
  }

  return result[0].values.length;
}
{{end}}

{{if eq .Cmd ":execresult"}}
{{range .Comments}}//{{.}}
{{end -}}
export function {{.MethodName}}(db: Database, {{.Arg.Pair}}): QueryExecResult {
  const result = db.exec({{.ConstantName}}, [{{.Arg.Params}}]);
  if (result.length !== 1) {
    throw new Error("expected exec() to return a single query result")
  }

  return result[0];
}
{{end}}

{{end}}
{{end}}
{{end}}
